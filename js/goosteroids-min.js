/* 
 * Constants
 */function Ct(){var e=new Fn(ot.width/2,ot.height/2);lt=new Tn(e,P,j,H,B),lt.orientation=-r/2}function kt(){if(!lt.alive&&st>0){st--;var t=Math.ceil(st/e);t>0&&Wt(ot,at,t)}else!lt.alive&&st==0&&Ct()}function Lt(){at.clearRect(0,0,ot.width,ot.height),ct.length==0&&(ht=[],Dt()),hn(ct),Ft(ht),mn(ct,u,d,!0),Nn(lt,F),fn(pt),pn(at,ft,ct),Cn(at,lt,F,R,U,z);if(lt.accelerating&&!lt.abActivated){var e=An(I,F,tt,et);kn(at,lt,e,null,G,Y)}if(lt.accelerating&&lt.abActivated&&lt.abFuel>0){var e=An(I,F,rt,nt);kn(at,lt,e,null,G,Y)}It(at,ht),ln(at,pt),zt(ot,at,lt.abFuel),Rt(ot,at,St),Ut(ot,at,Tt),qt(ot,at,xt);if(Tt<0){_t();return}kt()}function At(){Nt=setInterval(Lt,1e3/e)}function Ot(){clearInterval(Nt)}function Mt(){ot=document.getElementById("gameCanvas"),at=ot.getContext("2d"),ut=document.createElement("canvas"),ut.width=ot.width,ut.height=ot.height,ft=ut.getContext("2d"),F=Ln(I,q),xn(St),Ct(),$("body").focus(),$("body").keydown(function(e){Jt(e)}),$("body").keyup(function(e){Kt(e)}),Vt(new Xt(mt,Qt)),$t(new Xt(mt,Gt)),Vt(new Xt(yt,Yt)),$t(new Xt(yt,Zt)),Vt(new Xt(bt,en)),$t(new Xt(bt,tn)),Vt(new Xt(wt,nn)),$t(new Xt(wt,rn)),Vt(new Xt(Et,sn)),$t(new Xt(Et,on))}function _t(){Ot(),$("#gameOverContainer").show(),$("#gameContainer").fadeOut(2e3)}function Dt(){Ot(),St++,$("#stageMessage").html("Stage "+St),$("#stageContainer").fadeIn(2500,function(){setTimeout(function(){$("#stageContainer").fadeOut(1e3),$("#gameContainer").fadeIn(2e3),xn(St),Ct(),At()},500)})}function Pt(){$("#introductionContainer").fadeOut(2e3),$("#instructionsContainer").fadeIn(2e3)}function Ht(){$("#instructionsContainer").stop(),$("#stageMessage").html("Stage "+St),$("#instructionsContainer").fadeOut(2e3),$("#stageContainer").fadeIn(2e3,function(){setTimeout(function(){$("#gameContainer").show(),$("#stageContainer").fadeOut(2e3,function(){Mt(),At()})},500)})}function jt(e,t,n,r){this.position=e,this.velocity=In(t,n),this.lifetime=r,this.age=0,this.lifetime=r}function Ft(e){var n=ot.width-1,r=ot.height-1;for(var i=0;i<e.length;i++){var s=e[i];s.age++,s.lifetime>0&&s.age>s.lifetime?e.splice(i,1):(s.position=s.position.add(s.velocity.scale(t)),s.position.x>n&&(s.position.x=0),s.position.x<0&&(s.position.x=n),s.position.y>r&&(s.position.y=0),s.position.y<0&&(s.position.y=r));for(var o=0;o<ct.length;o++){var u=ct[o];if(qn(s.position,u.position)<u.radius+x+g/2){e.splice(i,1),ct.splice(o,1),pt.push(new an(u.position,a,C,L,w)),xt+=10;for(var c=0;c<ct.length;c++){var h=ct[c];if(o!=c&&qn(u.position,h.position)<h.radius+u.radius+f){var p=h.position.sub(u.position).normalize(),d=p.scale(l);h.addImpulse(d)}}}}}}function It(e,t){for(var n=0;n<t.length;n++)Bn(e,t[n].position,x,T)}function qt(e,t,n){var r=new Fn(e.width-90,40);t.save(),t.font="bold 24px Arial",t.fillStyle="white",t.fillText(n,r.x,r.y),t.restore()}function Rt(e,t,n){t.save(),t.font="bold 10px Arial",t.fillStyle="white",t.fillText("STAGE",20,55),t.fillText(n,60,55),t.restore()}function Ut(e,t,n){t.save(),t.font="bold 10px Arial",t.fillStyle="white",t.fillText("LIVES",20,75),t.fillText(n,60,75),t.restore()}function zt(e,t,n){var r=new Fn(20,34);t.save(),t.font="bold 10px Arial",t.fillStyle="white",t.fillText("TURBO",r.x,r.y),t.beginPath(),t.rect(r.x+43,r.y-9,102,10),t.fillStyle="white",t.fill(),t.lineWidth=2,t.strokeStyle="white",t.stroke(),t.beginPath(),t.rect(r.x+44,r.y-8,n/J*100,8),t.fillStyle="grey",t.fill(),t.restore()}function Wt(e,t,n){var r=new Fn(e.width/2,e.height/2);t.save(),t.font="bold 18px Arial",t.fillStyle="white",t.textAlign="center",t.fillText("RESPAWNING IN "+n,r.x,r.y),t.restore()}function Xt(e,t){this.key=e,this.action=t}function Vt(e){dt.push(e)}function $t(e){vt.push(e)}function Jt(e){for(var t=0;t<dt.length;t++){var n=dt[t];n.key==e.which&&(n.action(),e.preventDefault())}}function Kt(e){for(var t=0;t<vt.length;t++){var n=vt[t];n.key==e.which&&(n.action(),e.preventDefault())}}function Qt(){lt.accelerating=1}function Gt(){lt.accelerating=0}function Yt(){lt.turning=-1}function Zt(){lt.turning=0}function en(){lt.turning=1}function tn(){lt.turning=0}function nn(){lt.gunFiring=!0}function rn(){lt.gunFiring=!1}function sn(){lt.abActivated=!0}function on(){lt.abActivated=!1,lt.abCooldown=K}function un(e,n,r,s,o,u){var a=[];for(var f=0;f<o;f++){var l=new In(Math.random()*i,Math.random()*n),c=new dn(r,s,e.add(l.scale(t)),l);a.push(c)}return a}function an(e,t,n,r,i){this.position=e,this.particles=un(e,t,1,k,n,!1),this.age=0,this.lifetime=r,this.color=i}function fn(e){for(var t=0;t<e.length;t++){var n=e[t];n.age++,n.lifetime>0&&n.age>n.lifetime?(n.particles=[],e.splice(t,1)):mn(n.particles,a,N,!1)}}function ln(e,t){for(var n=0;n<t.length;n++)gn(e,t[n].particles,t[n].color)}function cn(e,t,n,r){var i=qn(e.position,t.position);if(i<e.radius+t.radius)return new Fn(0,0);var s=n*e.mass*t.mass*Math.exp(-r*i),o=t.position.sub(e.position).normalize();return o.scale(s)}function hn(e){for(var t=0;t<e.length;t++)for(var n=0;n<e.length;n++)t!=n&&e[t].addForce(cn(e[t],e[n],s,o))}function pn(e,t,n){t.clearRect(0,0,ut.width,ut.height);for(var r=0;r<n.length;r++){particle=n[r],t.beginPath();var s=t.createRadialGradient(particle.position.x,particle.position.y,particle.radius,particle.position.x,particle.position.y,g);s.addColorStop(0,y),s.addColorStop(1,b),t.fillStyle=s,t.arc(particle.position.x,particle.position.y,particle.radius+g,0,i),t.fill()}var o=t.getImageData(0,0,ut.width,ut.height),u=o.data;for(var r=0;r<u.length;r+=4){var a=r+3;u[a]<m?u[a]=0:m<=u[a]&&u[a]<=v?u[a]=255:u[a]>v&&(u[a]=255)}e.putImageData(o,0,0)}function dn(e,t,n,r){this.radius=t,this.mass=e,this.position=n,this.velocity=r,this.acceleration=new Fn(0,0),this.forces=[]}function vn(e,t){this.particle1=e,this.particle2=t,this.contactNormal=t.position.sub(e.position).normalize(),this.interpenetrationDepth=e.radius+t.radius-qn(e.position,t.position)}function mn(e,r,i,s){var o=ot.width-1,u=ot.height-1,a=[];for(var f=0;f<e.length;f++){var l=e[f];l.applyForces(),l.clearForces(),l.velocity=l.velocity.scale(Math.pow(i,t)).add(l.acceleration.scale(t)),l.velocity=l.velocity.normalize().scale(Pn(l.velocity.norm(),0,r)),l.position=l.position.add(l.velocity.scale(t)).add(l.acceleration.scale(n)),l.position.x>o&&(l.position.x=0),l.position.x<0&&(l.position.x=o),l.position.y>u&&(l.position.y=0),l.position.y<0&&(l.position.y=u);if(s)for(var c=f+1;c<e.length;c++){var h=e[c];qn(l.position,h.position)<l.radius+h.radius&&a.push(new vn(l,h))}}if(s)for(var c=0;c<a.length;c++)a[c].resolveInterpenetration(),a[c].resolveVelocity()}function gn(e,t,n){for(var r=0;r<t.length;r++)Bn(e,t[r].position,t[r].radius,n)}function yn(e,t,n,r){var i=un(t,a,c,p,e,!0);for(var s=0;s<i.length;s++)i[s].velocity=In(n,r);return i}function bn(e){for(var t=0;t<e.length;t++){var n=yn(e[t].size,new Fn(Hn(0,$("#canvas").width()-1),Hn(0,$("#canvas").height()-1)),Hn(0,i),e[t].speed);for(var r=0;r<n.length;r++)ct.push(n[r])}}function wn(){s=40,o=.001,u=400,f=30,l=u/2,h=.8;var e=[{size:20,speed:u/2}];bn(e)}function En(){s=30,o=.005,u=400,f=30,l=u/2,h=.8;var e=[{size:20,speed:u/2},{size:10,speed:u}];bn(e)}function Sn(){s=100,o=.01,u=500,f=30,l=u,h=.8;var e=[{size:20,speed:u/3},{size:15,speed:u/2},{size:20,speed:2*u/3}];bn(e)}function xn(e){switch(e){case 1:wn();break;case 2:En();break;case 3:Sn();break;default:Sn()}}function Tn(e,t,n,r,i){this.alive=!0,this.gunFiring=!1,this.gunCooldown=0,this.abActivated=!1,this.abCooldown=0,this.abFuel=J,this.position=e,this.orientation=0,this.velocity=new Fn(0,0),this.maxSpeed=t,this.damping=n,this.acceleration=r,this.turnRate=i,this.turning=0,this.accelerating=0}function Nn(e,i){if(e.alive){var s=ot.width-1,o=ot.height-1,u=In(e.orientation,1).scale(e.accelerating*e.acceleration);e.velocity=e.velocity.scale(Math.pow(e.damping,t)).add(u.scale(t)),e.velocity=e.velocity.normalize().scale(Pn(e.velocity.norm(),0,e.maxSpeed)),e.position=e.position.add(e.velocity.scale(t)).add(u.scale(n)),e.orientation+=e.turning*e.turnRate*t,e.position.x>s&&(e.position.x=0),e.position.x<0&&(e.position.x=s),e.position.y>o&&(e.position.y=0),e.position.y<0&&(e.position.y=o);for(var a=0;a<ct.length;a++){var f=ct[a],l=f.position.sub(e.position);l=In(l.angle()-e.orientation+r/2,l.norm());if(Dn(l,f.radius+.25*g,i[0],i[1],i[2])){e.alive=!1,Tt--,st=it,pt.push(new an(e.position,5*A,C,L,O)),pt.push(new an(e.position,2*A,4*C,L,M)),pt.push(new an(e.position,A,C,L,_));return}}e.gunCooldown>0&&e.gunCooldown--;if(e.gunFiring&&e.gunCooldown==0){var c=F[1];c=In(c.angle()+e.orientation-r/2,c.norm()+z),c=c.add(e.position),ht.push(new jt(c,e.orientation,E,S)),e.gunCooldown=D}e.abCooldown>0&&e.abCooldown--,e.abActivated?e.abFuel>0?(e.acceleration=W,e.maxSpeed=Q,e.abFuel-=X,e.abFuel=Pn(e.abFuel,0,J)):e.abFuel==0&&(e.acceleration=H,e.maxSpeed=P):(e.acceleration=H,e.maxSpeed=P,e.abCooldown==0&&e.abFuel<J&&(e.abFuel+=V,e.abFuel=Pn(e.abFuel,0,J)))}}function Cn(e,t,n,i,s,o){t.alive&&(e.save(),e.translate(t.position.x,t.position.y),e.rotate(t.orientation-r/2),jn(e,n,i,s,o),e.restore())}function kn(e,t,n,i,s,o){t.alive&&(e.save(),e.translate(t.position.x,t.position.y),e.rotate(t.orientation-r/2),jn(e,n,i,s,o),e.restore())}function Ln(e,t){var n=Math.sqrt(t*t+.25*e*e),r=Math.atan(2*t/e),i=new Fn(0,0),s=In(r,n),o=In(0,e),u=i.add(s.add(o)).scale(1/3);return i=i.sub(u),s=s.sub(u),o=o.sub(u),[i,s,o,i]}function An(e,t,n,r){var i=t[0],s=[i];for(var o=n;o<e;o+=n)s.push(new Fn(i.x+o,i.y-Hn(0,r)-2));return s.push(t[t.length-2]),s}function On(e,t,n,r){var i=e.sub(n).cross(r.sub(n)),s=t.sub(n).cross(r.sub(n));return i*s>=0}function Mn(e,t,n,r){return On(e,r,t,n)&&On(e,t,n,r)&&On(e,n,r,t)}function _n(e,t,n){var r=e.sub(t).dot(n.sub(t))/n.sub(t).dot(n.sub(t)),i=t.add(n.sub(t).scale(r));return{t:r,op:i}}function Dn(e,t,n,r,i){if(Mn(e,n,r,i))return!0;if(qn(e,n)<t||qn(e,r)<t||qn(e,i)<t)return!0;var s=_n(e,n,r);return 0<s.t&&s.t<1&&qn(e,s.op)<t?!0:(s=_n(e,r,i),0<s.t&&s.t<1&&qn(e,s.op)<t?!0:(s=_n(e,i,n),0<s.t&&s.t<1&&qn(e,s.op)<t?!0:!1))}function Pn(e,t,n){return e<t?t:e>n?n:e}function Hn(e,t){return e+Math.random()*(t-e)}function Bn(e,t,n,r){e.beginPath(),e.fillStyle=r,e.arc(t.x,t.y,n,0,i),e.closePath(),e.fill()}function jn(e,t,n,r,i){e.beginPath(),e.moveTo(t[0].x,t[0].y);for(var s=1;s<t.length;s++)e.lineTo(t[s].x,t[s].y);n&&(e.fillStyle=n,e.fill()),r&&(e.lineWidth=i,e.strokeStyle=r,e.stroke())}function Fn(e,t){this.x=e,this.y=t}function In(e,t){return new Fn(t*Math.cos(e),t*Math.sin(e))}function qn(e,t){return e.sub(t).norm()}var e=30,t=1/e,n=t*t,r=Math.PI,i=2*Math.PI,s=30,o=.001,u=400,a=250,f=30,l=700,c=1,h=.8,p=5,d=1,v=200,m=150,g=p*3,y="rgba(80, 80, 80, 1)",b="rgba(80, 80, 80, 0)",w="#b0b0b0",E=650,S=20,x=2,T="#ffffff",N=.9,C=15,k=2,L=15,A=1e3,O="black",M="white",_="yellow",D=6,P=400,H=500,B=i/(e*.04),j=.5,F=[],I=15,q=25,R="#ffffff",U="#000000",z=3,W=6*H,X=5,V=2,J=100,K=60,Q=2.25*P,G="blue",Y=3,Z="#ffffff",et=6,tt=2,nt=17,rt=3,it=3*e,st=0,ot=null,ut=null,at=null,ft=null,lt=null,ct=[],ht=[],pt=[],dt=[],vt=[],mt=38,gt=40,yt=37,bt=39,wt=32,Et=16,St=1,xt=0,Tt=3,Nt=null;$(document).ready(function(){$("#playButton").click(Ht),setTimeout(Pt,2500),console.log("SESSION_ID: "+Bt)});var Bt="<%= @session_id %>";dn.prototype.inverseMass=function(){return 1/this.mass},dn.prototype.applyForces=function(){var e=new Fn(0,0);for(var t=0;t<this.forces.length;t++)e=e.add(this.forces[t]);this.acceleration=e.scale(this.inverseMass())},dn.prototype.addForce=function(e){this.forces.push(e)},dn.prototype.clearForces=function(){this.forces=[]},dn.prototype.addImpulse=function(e){this.velocity=this.velocity.add(e.scale(this.inverseMass()))},vn.prototype.resolveInterpenetration=function(){var e=this.particle1.inverseMass()+this.particle2.inverseMass();this.particle1.position=this.particle1.position.add(this.contactNormal.scale(-1*this.particle1.mass*e*this.interpenetrationDepth)),this.particle2.position=this.particle2.position.add(this.contactNormal.scale(this.particle2.mass*e*this.interpenetrationDepth))},vn.prototype.resolveVelocity=function(){var e=this.particle2.velocity.sub(this.particle1.velocity),t=e.dot(this.contactNormal);if(t>0)return;var n=-1*h*t,r=n-t,i=this.particle1.inverseMass()+this.particle2.inverseMass(),s=r/i,o=this.contactNormal.scale(s);this.particle1.addImpulse(o.scale(-1)),this.particle2.addImpulse(o)},Fn.prototype.add=function(e){return new Fn(this.x+e.x,this.y+e.y)},Fn.prototype.sub=function(e){return new Fn(this.x-e.x,this.y-e.y)},Fn.prototype.scale=function(e){return new Fn(e*this.x,e*this.y)},Fn.prototype.dot=function(e){return this.x*e.x+this.y*e.y},Fn.prototype.cross=function(e){return this.x*e.y-this.y*e.x},Fn.prototype.angle=function(){return Math.atan(this.y,this.x)},Fn.prototype.norm=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},Fn.prototype.normalize=function(){var e=this.norm();return e==0?this:this.scale(1/e)},Fn.prototype.toString=function(){return"Vector("+this.x+", "+this.y+")"};