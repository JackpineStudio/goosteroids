/* 
 * Constants
 */function xt(){var e=new Ln(rt.width/2,rt.height/2);ut=new dn(e,D,B,P,H),ut.orientation=-r/2}function Tt(){clearInterval(St),$("#gameContainer").fadeOut(1e3),$("#gameOverContainer").fadeIn(4e3)}function Nt(){clearInterval(St),$("#stageOverMessage").html("Stage "+bt+" complete!<br>Prepare for stage "+(bt+1)+"..."),$("#gameContainer").fadeOut(1e3),$("#stageOverContainer").fadeIn(4e3,function(){setTimeout(function(){$("#stageOverContainer").hide(),$("#gameContainer").fadeIn(4e3),bt++,pn(bt),xt(),St=setInterval(kt,1e3/e)},1e3)})}function Ct(){if(!ut.alive&&nt){nt--;var t=Math.ceil(nt/e);t>0&&Ht(rt,st,t)}else!ut.alive&&nt==0&&xt()}function kt(){st.clearRect(0,0,rt.width,rt.height),at.length==0&&(ft=[],Nt()),tn(at),Ot(ft),on(at,u,d,!0),vn(ut,j),Yt(lt),nn(st,ot,at),mn(st,ut,j,q,R);if(ut.accelerating&&!ut.abActivated){var e=bn(F,j,Y,G);gn(st,ut,e,null,K)}if(ut.accelerating&&ut.abActivated&&ut.abFuel>0){var e=bn(F,j,et,Z);gn(st,ut,e,null,K)}Mt(st,ft),Zt(st,lt),Pt(rt,st,ut.abFuel),_t(rt,st,wt),Dt(rt,st,Et);if(Et<0){Tt();return}Ct()}function At(e,t,n,r){this.position=e,this.velocity=An(t,n),this.lifetime=r,this.age=0,this.lifetime=r}function Ot(e){var n=rt.width-1,r=rt.height-1;for(var i=0;i<e.length;i++){var s=e[i];s.age++,s.lifetime>0&&s.age>s.lifetime?e.splice(i,1):(s.position=s.position.add(s.velocity.scale(t)),s.position.x>n&&(s.position.x=0),s.position.x<0&&(s.position.x=n),s.position.y>r&&(s.position.y=0),s.position.y<0&&(s.position.y=r));for(var o=0;o<at.length;o++){var u=at[o];if(On(s.position,u.position)<u.radius+x+g/2){e.splice(i,1),at.splice(o,1),lt.push(new Gt(u.position,a,C,L,w)),wt+=10;for(var c=0;c<at.length;c++){var h=at[c];if(o!=c&&On(u.position,h.position)<h.radius+u.radius+f){var p=h.position.sub(u.position).normalize(),d=p.scale(l);h.addImpulse(d)}}}}}}function Mt(e,t){for(var n=0;n<t.length;n++)Cn(e,t[n].position,x,T)}function _t(e,t,n){var r=new Ln(e.width-90,40);t.save(),t.font="bold 20px sans-serif",t.fillStyle="black",t.fillText(n,r.x,r.y),t.restore()}function Dt(e,t,n){t.save(),t.font="12px sans-serif",t.fillStyle="black",t.fillText("Lives  "+n,20,55),t.restore()}function Pt(e,t,n){var r=new Ln(20,34);t.save(),t.font="12px sans-serif",t.fillStyle="black",t.fillText("Turbo",r.x,r.y),t.beginPath(),t.rect(r.x+40,r.y-9,102,10),t.fillStyle="white",t.fill(),t.lineWidth=2,t.strokeStyle="black",t.stroke(),t.beginPath(),t.rect(r.x+41,r.y-8,n/X*100,8),t.fillStyle="grey",t.fill(),t.restore()}function Ht(e,t,n){var r=new Ln(e.width/2,e.height/2);t.save(),t.font="bold 16px sans-serif",t.fillStyle="black",t.textAlign="center",t.fillText("Respawn in "+n,r.x-15,r.y),t.restore()}function Bt(e,t){this.key=e,this.action=t}function jt(e){ct.push(e)}function Ft(e){ht.push(e)}function It(e){for(var t=0;t<ct.length;t++){var n=ct[t];n.key==e.which&&(n.action(),e.preventDefault())}}function qt(e){for(var t=0;t<ht.length;t++){var n=ht[t];n.key==e.which&&(n.action(),e.preventDefault())}}function Rt(){ut.accelerating=1}function Ut(){ut.accelerating=0}function zt(){ut.turning=-1}function Wt(){ut.turning=0}function Xt(){ut.turning=1}function Vt(){ut.turning=0}function $t(){if(ut.alive&&ut.gunCooldown==0){var e=j[1];e=An(e.angle()+ut.orientation-r/2,e.norm()),e=e.add(ut.position),ft.push(new At(e,ut.orientation,E,S)),ut.gunCooldown=_}}function Jt(){ut.abActivated=!0}function Kt(){ut.abActivated=!1,ut.abCooldown=V}function Qt(e,n,r,s,o,u){var a=[];for(var f=0;f<o;f++){var l=new An(Math.random()*i,Math.random()*n),c=new rn(r,s,e.add(l.scale(t)),l);a.push(c)}return a}function Gt(e,t,n,r,i){this.position=e,this.particles=Qt(e,t,1,k,n,!1),this.age=0,this.lifetime=r,this.color=i}function Yt(e){for(var t=0;t<e.length;t++){var n=e[t];n.age++,n.lifetime>0&&n.age>n.lifetime?(n.particles=[],e.splice(t,1)):on(n.particles,a,N,!1)}}function Zt(e,t){for(var n=0;n<t.length;n++)un(e,t[n].particles,t[n].color)}function en(e,t,n,r){var i=On(e.position,t.position);if(i<e.radius+t.radius)return new Ln(0,0);var s=n*e.mass*t.mass*Math.exp(-r*i),o=t.position.sub(e.position).normalize();return o.scale(s)}function tn(e){for(var t=0;t<e.length;t++)for(var n=0;n<e.length;n++)t!=n&&e[t].addForce(en(e[t],e[n],s,o))}function nn(e,t,n){t.clearRect(0,0,it.width,it.height);for(var r=0;r<n.length;r++){particle=n[r],t.beginPath();var s=t.createRadialGradient(particle.position.x,particle.position.y,particle.radius,particle.position.x,particle.position.y,g);s.addColorStop(0,y),s.addColorStop(1,b),t.fillStyle=s,t.arc(particle.position.x,particle.position.y,particle.radius+g,0,i),t.fill()}var o=t.getImageData(0,0,it.width,it.height),u=o.data;for(var r=0;r<u.length;r+=4){var a=r+3;u[a]<m?u[a]=0:m<=u[a]&&u[a]<=v?u[a]=255:u[a]>v&&(u[a]=255)}e.putImageData(o,0,0)}function rn(e,t,n,r){this.radius=t,this.mass=e,this.position=n,this.velocity=r,this.acceleration=new Ln(0,0),this.forces=[]}function sn(e,t){this.particle1=e,this.particle2=t,this.contactNormal=t.position.sub(e.position).normalize(),this.interpenetrationDepth=e.radius+t.radius-On(e.position,t.position)}function on(e,r,i,s){var o=rt.width-1,u=rt.height-1,a=[];for(var f=0;f<e.length;f++){var l=e[f];l.applyForces(),l.clearForces(),l.velocity=l.velocity.scale(Math.pow(i,t)).add(l.acceleration.scale(t)),l.velocity=l.velocity.normalize().scale(Tn(l.velocity.norm(),0,r)),l.position=l.position.add(l.velocity.scale(t)).add(l.acceleration.scale(n)),l.position.x>o&&(l.position.x=0),l.position.x<0&&(l.position.x=o),l.position.y>u&&(l.position.y=0),l.position.y<0&&(l.position.y=u);if(s)for(var c=f+1;c<e.length;c++){var h=e[c];On(l.position,h.position)<l.radius+h.radius&&a.push(new sn(l,h))}}if(s)for(var c=0;c<a.length;c++)a[c].resolveInterpenetration(),a[c].resolveVelocity()}function un(e,t,n){for(var r=0;r<t.length;r++)Cn(e,t[r].position,t[r].radius,n)}function an(e,t,n,r){var i=Qt(t,a,c,p,e,!0);for(var s=0;s<i.length;s++)i[s].velocity=An(n,r);return i}function fn(e){for(var t=0;t<e.length;t++){var n=an(e[t].size,new Ln(Nn(0,$("#canvas").width()-1),Nn(0,$("#canvas").height()-1)),Nn(0,i),e[t].speed);for(var r=0;r<n.length;r++)at.push(n[r])}}function ln(){s=40,o=.001,u=400,f=30,l=u/2,h=.8;var e=[{size:20,speed:u/2}];fn(e)}function cn(){s=30,o=.005,u=500,f=30,l=u/2,h=.8;var e=[{size:20,speed:u/2},{size:10,speed:u}];fn(e)}function hn(){s=100,o=.01,u=600,f=30,l=u,h=.8;var e=[{size:20,speed:u/3},{size:15,speed:u/2},{size:20,speed:2*u/3}];fn(e)}function pn(e){switch(e){case 1:ln();break;case 2:cn();break;case 3:hn();break;default:hn()}}function dn(e,t,n,r,i){this.alive=!0,this.gunCooldown=0,this.abActivated=!1,this.abCooldown=0,this.abFuel=X,this.position=e,this.orientation=0,this.velocity=new Ln(0,0),this.maxSpeed=t,this.damping=n,this.acceleration=r,this.turnRate=i,this.turning=0,this.accelerating=0}function vn(e,i){if(e.alive){var s=rt.width-1,o=rt.height-1,u=An(e.orientation,1).scale(e.accelerating*e.acceleration);e.velocity=e.velocity.scale(Math.pow(e.damping,t)).add(u.scale(t)),e.velocity=e.velocity.normalize().scale(Tn(e.velocity.norm(),0,e.maxSpeed)),e.position=e.position.add(e.velocity.scale(t)).add(u.scale(n)),e.orientation+=e.turning*e.turnRate*t,e.position.x>s&&(e.position.x=0),e.position.x<0&&(e.position.x=s),e.position.y>o&&(e.position.y=0),e.position.y<0&&(e.position.y=o);for(var a=0;a<at.length;a++){var f=at[a],l=f.position.sub(e.position);l=An(l.angle()-e.orientation+r/2,l.norm());if(xn(l,f.radius+.25*g,i[0],i[1],i[2])){e.alive=!1,Et--,nt=tt,lt.push(new Gt(e.position,A,C/5,L,"black")),lt.push(new Gt(e.position,A,C,L,O)),lt.push(new Gt(e.position,A,C,L,M));return}}e.gunCooldown>0&&e.gunCooldown--,e.abCooldown>0&&e.abCooldown--,e.abActivated?e.abFuel>0?(e.acceleration=U,e.maxSpeed=J,e.abFuel-=z,e.abFuel=Tn(e.abFuel,0,X)):e.abFuel==0&&(e.acceleration=P,e.maxSpeed=D):(e.acceleration=P,e.maxSpeed=D,e.abCooldown==0&&e.abFuel<X&&(e.abFuel+=W,e.abFuel=Tn(e.abFuel,0,X)))}}function mn(e,t,n,i,s){t.alive&&(e.save(),e.translate(t.position.x,t.position.y),e.rotate(t.orientation-r/2),kn(e,n,i,s),e.restore())}function gn(e,t,n,i,s){t.alive&&(e.save(),e.translate(t.position.x,t.position.y),e.rotate(t.orientation-r/2),kn(e,n,i,s),e.restore())}function yn(e,t){var n=Math.sqrt(t*t+.25*e*e),r=Math.atan(2*t/e),i=new Ln(0,0),s=An(r,n),o=An(0,e),u=i.add(s.add(o)).scale(1/3);return i=i.sub(u),s=s.sub(u),o=o.sub(u),[i,s,o,i]}function bn(e,t,n,r){var i=t[0],s=[i];for(var o=n;o<e;o+=n)s.push(new Ln(i.x+o,i.y-Nn(0,r)-2));return s.push(t[t.length-2]),s}function wn(e,t,n,r){var i=e.sub(n).cross(r.sub(n)),s=t.sub(n).cross(r.sub(n));return i*s>=0}function En(e,t,n,r){return wn(e,r,t,n)&&wn(e,t,n,r)&&wn(e,n,r,t)}function Sn(e,t,n){var r=e.sub(t).dot(n.sub(t))/n.sub(t).dot(n.sub(t)),i=t.add(n.sub(t).scale(r));return{t:r,op:i}}function xn(e,t,n,r,i){if(En(e,n,r,i))return!0;if(On(e,n)<t||On(e,r)<t||On(e,i)<t)return!0;var s=Sn(e,n,r);return 0<s.t&&s.t<1&&On(e,s.op)<t?!0:(s=Sn(e,r,i),0<s.t&&s.t<1&&On(e,s.op)<t?!0:(s=Sn(e,i,n),0<s.t&&s.t<1&&On(e,s.op)<t?!0:!1))}function Tn(e,t,n){return e<t?t:e>n?n:e}function Nn(e,t){return e+Math.random()*(t-e)}function Cn(e,t,n,r){e.beginPath(),e.fillStyle=r,e.arc(t.x,t.y,n,0,i),e.closePath(),e.fill()}function kn(e,t,n,r){e.beginPath(),e.moveTo(t[0].x,t[0].y);for(var i=1;i<t.length;i++)e.lineTo(t[i].x,t[i].y);n&&(e.fillStyle=n,e.fill()),r&&(e.lineWidth=3,e.strokeStyle=r,e.stroke())}function Ln(e,t){this.x=e,this.y=t}function An(e,t){return new Ln(t*Math.cos(e),t*Math.sin(e))}function On(e,t){return e.sub(t).norm()}var e=30,t=1/e,n=t*t,r=Math.PI,i=2*Math.PI,s=30,o=.001,u=400,a=250,f=30,l=700,c=1,h=.8,p=5,d=1,v=200,m=150,g=p*3,y="rgba(80, 80, 80, 1)",b="rgba(80, 80, 80, 0)",w="#999999",E=650,S=20,x=2,T="#000000",N=.9,C=15,k=2,L=9,A=2e3,O="red",M="yellow",_=4,D=400,P=500,H=i/(e*.04),B=.5,j=[],F=15,I=25,q="#ffffff",R="#000000",U=6*P,z=5,W=2,X=100,V=60,J=2.25*D,K="blue",Q="#ffffff",G=6,Y=2,Z=17,et=3,tt=3*e,nt=0,rt=null,it=null,st=null,ot=null,ut=null,at=[],ft=[],lt=[],ct=[],ht=[],pt=38,dt=40,vt=37,mt=39,gt=32,yt=16,bt=1,wt=0,Et=3,St=null;$(document).ready(function(){rt=document.getElementById("canvas"),st=rt.getContext("2d");var t=$(window).height()/2-$("#canvas").height()/2,n=$(window).width()/2-$("#canvas").width()/2;$("#canvas").css({position:"absolute",top:t+"px",left:n+"px",borderStyle:"solid",borderWidth:"2px",backgroundColor:"#fff"}),it=document.createElement("canvas"),it.width=rt.width,it.height=rt.height,ot=it.getContext("2d"),j=yn(F,I),pn(bt),xt(),$("body").focus(),$("body").keydown(function(e){It(e)}),$("body").keyup(function(e){qt(e)}),jt(new Bt(pt,Rt)),Ft(new Bt(pt,Ut)),jt(new Bt(vt,zt)),Ft(new Bt(vt,Wt)),jt(new Bt(mt,Xt)),Ft(new Bt(mt,Vt)),jt(new Bt(gt,$t)),jt(new Bt(yt,Jt)),Ft(new Bt(yt,Kt)),St=setInterval(kt,1e3/e)});var Lt="<%= @session_id %>";$(document).ready(function(){alert(Lt)}),rn.prototype.inverseMass=function(){return 1/this.mass},rn.prototype.applyForces=function(){var e=new Ln(0,0);for(var t=0;t<this.forces.length;t++)e=e.add(this.forces[t]);this.acceleration=e.scale(this.inverseMass())},rn.prototype.addForce=function(e){this.forces.push(e)},rn.prototype.clearForces=function(){this.forces=[]},rn.prototype.addImpulse=function(e){this.velocity=this.velocity.add(e.scale(this.inverseMass()))},sn.prototype.resolveInterpenetration=function(){var e=this.particle1.inverseMass()+this.particle2.inverseMass();this.particle1.position=this.particle1.position.add(this.contactNormal.scale(-1*this.particle1.mass*e*this.interpenetrationDepth)),this.particle2.position=this.particle2.position.add(this.contactNormal.scale(this.particle2.mass*e*this.interpenetrationDepth))},sn.prototype.resolveVelocity=function(){var e=this.particle2.velocity.sub(this.particle1.velocity),t=e.dot(this.contactNormal);if(t>0)return;var n=-1*h*t,r=n-t,i=this.particle1.inverseMass()+this.particle2.inverseMass(),s=r/i,o=this.contactNormal.scale(s);this.particle1.addImpulse(o.scale(-1)),this.particle2.addImpulse(o)},Ln.prototype.add=function(e){return new Ln(this.x+e.x,this.y+e.y)},Ln.prototype.sub=function(e){return new Ln(this.x-e.x,this.y-e.y)},Ln.prototype.scale=function(e){return new Ln(e*this.x,e*this.y)},Ln.prototype.dot=function(e){return this.x*e.x+this.y*e.y},Ln.prototype.cross=function(e){return this.x*e.y-this.y*e.x},Ln.prototype.angle=function(){return Math.atan(this.y,this.x)},Ln.prototype.norm=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},Ln.prototype.normalize=function(){var e=this.norm();return e==0?this:this.scale(1/e)},Ln.prototype.toString=function(){return"Vector("+this.x+", "+this.y+")"};